###################### Metricbeat Configuration Example #######################

# This file is an example configuration file highlighting only the most common
# options. The metricbeat.full.yml file from the same directory contains all the
# supported options with more comments. You can use it as a reference.
#
# You can find the full configuration reference here:
# https://www.elastic.co/guide/en/beats/metricbeat/index.html

########################### General ########################################
# 
# https://www.elastic.co/guide/en/beats/metricbeat/current/configuration-general.html
#

{% if 'name' in metricbeat_combined %}
# The name of the shipper that publishes the network data. It can be used to group
# all the transactions sent by a single shipper in the web interface. Default
# is the hostname.
name: "{{ metricbeat_combined.name }}"
{% endif %}

{% if 'tags' in metricbeat_combined %}
# The tags of the shipper are included in their own field with each
# transaction published.
tags: "{{ metricbeat_combined.tags }}"
{% endif %}

{% if 'fields' in metricbeat_combined %}
# Optional fields that you can specify to add additional information to the
# output.
fields:
{% for field in metricbeat_combined.fields %}
  {{ field }}
{% endfor %}
{% endif %}

{% if 'fields_under_root' in metricbeat_combined %}
# If this option is set to true, the custom fields are stored as top-level
# fields in the output document instead of being grouped under a fields
# sub-dictionary. If the custom field names conflict with other field names,
# then the custom fields overwrite the other fields. The default value is false.
fields_under_root: "{{ metricbeat_combined.fields_under_root }}"
{% endif %}

{% if 'queue_size' in metricbeat_combined %}
# The internal queue size for single events in the processing pipeline. 
# The default value is 1000.
queue_size: {{ metricbeat_combined.queue_size }}
{% endif %}

{% if 'bulk_queue_size' in metricbeat_combined %}
# (DO NOT TOUCH) The internal queue size for bulk events in the processing
# pipeline. The default value is 0.
bulk_queue_size: {{ metricbeat_combined.bulk_queue_size }}
{% endif %}

{% if 'max_procs' in metricbeat_combined and metricbeat_combined.max_procs %}
# Sets the maximum number of CPUs that can be executing simultaneously. The
# default is the number of logical CPUs available in the system.
max_procs: {{ metricbeat_combined.max_procs }}
{% endif %}





############################### Modules #######################################
#
# https://www.elastic.co/guide/en/beats/metricbeat/current/configuration-metricbeat.html
#
metricbeat.modules:
{% for module_name, module_settings in metricbeat_combined.modules.items() %}
  - module: {{ module_name }}
{% for key, val in module_settings.items() %}
{% if val is iterable and val is not string %}
    {{ key }}:
{% for val2 in val %}
      - {{ val2 }}
{% endfor %}
{% else %}
    {{ key }}: {{ val }}
{% endif %}
{% endfor %}
{% endfor %}





############################# Output ##########################################
#
# Configure what outputs to use when sending the data collected by the beat.
# Multiple outputs may be used.
#
output:

{% if 'elasticsearch' in metricbeat_combined.output %}
  # https://www.elastic.co/guide/en/beats/metricbeat/current/elasticsearch-output.html
  elasticsearch:
    # Array of hosts to connect to.
    hosts: {{ metricbeat_combined.output.elasticsearch.hosts }}

  # Optional protocol and basic auth credentials.
{% if 'protocol' in metricbeat_combined.output.elasticsearch %}
    protocol: "{{ metricbeat_combined.output.elasticsearch.protocol }}"
{% endif %}
{% if 'username' in metricbeat_combined.output.elasticsearch %}
    username: "{{ metricbeat_combined.output.elasticsearch.username }}"
{% endif %}
{% if 'password' in metricbeat_combined.output.elasticsearch %}
    password: "{{ metricbeat_combined.output.elasticsearch.password }}"
{% endif %}
{% endif %}



{% if 'logstash' in metricbeat_combined.output %}
  # https://www.elastic.co/guide/en/beats/metricbeat/current/logstash-output.html
  logstash:
    # The Logstash hosts
    hosts: {{ metricbeat_combined.output.logstash.hosts }}

    # Optional SSL. By default is off.
    # List of root certificates for HTTPS server verifications
{% if 'ssl' in metricbeat_combined.output.logstash %}
    ssl.certificate_authorities: "{{ metricbeat_combined.output.logstash.ssl.certificate_authorities }}"

    # Certificate for SSL client authentication
    ssl.certificate: "{{ metricbeat_combined.output.logstash.ssl.certificate }}"

    # Client Certificate Key
    ssl.key: "{{ metricbeat_combined.output.logstash.ssl.key }}"
{% endif %}
{% endif %}





############################# Logging #########################################
#
# https://www.elastic.co/guide/en/beats/metricbeat/current/configuration-logging.html
#

# There are three options for the log ouput: syslog, file, stderr.
# Under Windos systems, the log files are per default sent to the file output,
# under all other system per default to syslog.
{% if 'logging' in metricbeat_combined %}
logging:

  # Sets log level. The default log level is error.
  # Available log levels are: critical, error, warning, info, debug
  level: {{ metricbeat_combined.logging.level }}

  # Enable debug output for selected components. To enable all selectors use ["*"]
  # Other available selectors are beat, publish, service
  # Multiple selectors can be chained.
  selectors: {{ metricbeat_combined.logging.selectors }}

  # Send all logging output to syslog. On Windows default is false, otherwise
  # default is true.
  to_syslog: {{ metricbeat_combined.logging.to_syslog }}

  # Write all logging output to files. Beats automatically rotate files if rotateeverybytes
  # limit is reached.
  to_files: {{ metricbeat_combined.logging.to_files }}
  
  # To enable logging to files, to_files option has to be set to true
{% if 'files' in metricbeat_combined.logging %}
  files:
    # The directory where the log files will written to.
    path: "{{ metricbeat_combined.logging.files.path }}"

    # The name of the files where the logs are written to.
    name: "{{ metricbeat_combined.logging.files.name }}"

    # Configure log file size limit. If limit is reached, log file will be
    # automatically rotated
    rotateverybytes: {{ metricbeat_combined.logging.files.rotateeverybytes }}

    # Number of rotated log files to keep. Oldest files will be deleted first.
    keepfiles: {{ metricbeat_combined.logging.files.keepfiles }}
{% endif %}

  # Enable metrics recording
{% if 'metrics' in metricbeat_combined.logging %}
  metrics:
    enabled: {{ metricbeat_combined.logging.metrics.enabled }}
    period: {{ metricbeat_combined.logging.metrics.period }}
{% endif %}
{% endif %}
